
### 厘清业务的重要性
很多时候，困扰一个研发团队的时候，根本就不是技术难题，而是厘清复杂业务。

### 一定会出现的业务熵增

在业务迭代过程中，随着需求不断增加，代码中需要处理的变量往往会越来越多，业务逻辑的复杂度也随之增长。这就是软件工程中常见的"熵增"现象——系统会自然地朝着更复杂、更混乱的方向演化。

举例来说，用户输入文本，然后我们请求大模型，返回LLM结果给用户。

**第一天**，直接把用户的输入加上system prompt送到模型即可。如下：
```
func Chat(userId, userContent string) string,error{
    systemPe := getSystemPe()
    return QueryLLM(ctx, SystemPe, userContent)
}
```



**第二天**，老板要求需要针对不同等级用户写不同的SystemPrompt。

好说，我们直接加个判断即可。
```
func Chat(userId, userContent string) string,error{
    systemPeByUser := getSystemPe(userId)
    return QueryLLM(ctx, systemPeByUser, userContent)
}
```

**第三天**，老板要求根据用户的性别使用不同的LLM模型。

OK，继续加判断。
```
func Chat(userId, userContent string) string,error{
    systemPeByUser := getSystemPe(userId)
    llmModel := getLlmModel(userId)     // 获取用户对应的模型
    return QueryLLM(ctx, systemPeByUser, userContent, llmModel)
}
```

随着业务增多，你们团队的同学都来提交这一段代码。最后代码变成如下了。

```
func Chat(userId, userContent string) string,error{
    // 获取默认sysPe
    systemPeByUser := getSystemPe(userId)

    // 获取性别
    gender, err := getGender(userId)
    // 获取性别对应的PE
    sysPeByGender := getSystemPeByGender(userId)
    
    
    // 获取用户等级 
    ...
    // 获取用户等级对应的PE
    ...
    
    // 获取用户是否为vip
    ..
    // 获取vip用户对应的PE


    // 判定输入是否为敏感内容
    isSenstiveContent := checkSenstiveContent(userContent)
    llmModelSenstiveContent := getLLMModelBySenstiveContent(isSenstiveContent)


    // [复杂需求] 
    // 如果是男性，说的是敏感话题，则使用不同的PE，但如果是Vip则使用更贵的模型
    // 如果是女性，说的是用户等级超过5级，则使用5级以后得PE

    // 复杂需求2
    ..

    // 复杂需求3
    ...

    llmModel := getLlmModel(userId)     // 获取用户对应的模型
    return QueryLLM(ctx, systemPeByUser, userContent, llmModel)
}
```
为了让最终请求LLM的效果足够多样化，你们引入了非常多的变量，各种变量的组合来控制使用不同的LLM模型、SystemPE、是否带工具、带什么工具，以及userContent增加不同的槽位。

到最后，这个代码就变成一个"屎山代码"，没人说得清这里面的逻辑了。

**有一天**，老板说："如果用户是中国女性，则使用一个特定的SystemPE，并且使用特定的模型，并且返回一个表情包。"

此时，你已经头大了，你已经改不动了。老板说："你把满足这个条件的筛出来，然后设置参数进去不就好了。"

你无言以对，你知道这个条件跟之前很多条件是有关联的，你已经说不清了，但凡一改动，很可能影响以前的功能。


这是一个最常见的难题。

## 如何解决
要想解决上述问题，并非你钻研如何把代码写"好"写"对"是不够

在执行上述改造之前，**最重要的是把业务预期按照表格先列举出来**，让所有使用和实现该系统的人达成共识。因为有太多的情况会导致最终的规则覆盖，很多情况也要考虑按优先级覆盖。

梳理表格前，要关注**输入变量**和**输出变量**。

**输入变量：**
1. 性别
2. 等级
3. 是否会员
4. 国籍/地区
5. 是否敏感内容
6. ...

**输出变量：**
1. 使用什么SystemPE
2. 使用什么模型
3. 带什么userContent的槽位信息
4. 是否带工具，带什么工具
5. 回复类型（文本/语音/表情包）
6. ...

**所以，最终的流程是：**

1. 梳理业务，将需求/优先级/预期等列举到表格里
2. 明确各种限制条件对应的输出预期是什么
3. 管理所有的输入变量。可考虑使用规则引擎等组件。
4. 合理的封装，通过ChatSession获取到最终请求llm的ChatLlmModelParams。

比如最终的输入变量和输出变量信息可以维护到一个session里面：

```go
// ChatSession 聊天会话信息，包含输入变量和输出变量
type ChatSession struct {
	// ========== 输入变量 ==========
	// 用户基础信息
    UserInfoResult struct {
        UserID   string // 用户ID
        Gender   string // 性别: "male" | "female"
        Level    int    // 用户等级
        IsVIP    bool   // 是否会员
        Country  string // 国籍/地区
    }
	
	// 用户输入内容是否为敏感内容
    UserContentSensitiveCheckResult struct {
	    UserContent        string // 用户输入内容
	    IsSensitiveContent bool   // 是否为敏感内容
    }

    // 用户输入命中ai高质量储备内容
	AITopContentOutput *AITopContentOutput
	// 用户输入命中时下热点关键词
	AIPresetKeywordsOutput *AIPresetKeywordsOutput
	// 用户输入命中ai的人设剧情RAG
	CommonRAGOutput *CommonRAGOutput
	// 用户输入命中记忆RAG
	MemoryRAGOutput *MemoryRAGOutput
	// 用户聊天话题不足，ai补充热点话题
	ChatStatusOutput *ChatStatusOutput
	// 用户聊深刻话题
	DeepTopicOutput *JudgeDeepTopicOutput
	// 判断是否是调情
	JudgeFlirtOutput *JudgeFlirtOutput
}

type ChatLlmModelParams struct {
    SystemPE    string   // 使用的SystemPrompt
	LLMModel    string   // 使用的LLM模型
	Tools       []string // 需要使用的工具列表
	
	// 内容处理
	UserContentSlots map[string]interface{} // userContent的槽位信息

    // 响应相关
	ReplyType   int  // 回复类型: 0-普通文本, 1-语音条, >=2-表情包并结束
	NeedEmoji   bool // 是否需要返回表情包
}

```

通过这种方式，我们可以清晰地管理所有的输入变量，然后根据业务规则计算出对应的输出变量，最后统一进行LLM请求。

比如与上述结构对应的表格文档如下：

| 优先级 | 性别 | 等级 | 是否VIP | 国籍 | 是否敏感内容 | 命中AI高质量储备 | 命中热点关键词 | 命中人设剧情RAG | 命中记忆RAG | 话题不足补充 | 深刻话题 | 是否调情 | SystemPE | LLM模型 | 工具列表 | 回复类型 | 是否需要表情包 | 备注 |
|--------|------|------|---------|------|--------------|------------------|----------------|-----------------|------------|--------------|----------|----------|----------|---------|----------|----------|----------------|------|
| 1 | 女 | - | - | 中国 | - | - | - | - | - | - | - | - | syspe_chinese_female | gpt-4-turbo | [] | 2 | 是 | 中国女性用户特殊处理 |
| 2 | 男 | - | 是 | - | 是 | - | - | - | - | - | - | - | syspe_vip_male_sensitive | gpt-4-turbo | [tool1, tool2] | 0 | 否 | VIP男性敏感话题 |
| 3 | 男 | - | - | - | 是 | - | - | - | - | - | - | - | syspe_male_sensitive | gpt-3.5-turbo | [tool1] | 0 | 否 | 男性敏感话题 |
| 4 | 女 | >=5 | - | - | - | - | - | - | - | - | - | - | syspe_female_level5+ | gpt-4-turbo | [] | 0 | 否 | 女性5级以上用户 |
| 5 | - | >=10 | 是 | - | - | - | - | - | - | - | - | - | syspe_high_level_vip | gpt-4-turbo | [tool1, tool2, tool3] | 0 | 否 | 高等级VIP用户 |
| 6 | - | - | 是 | - | - | - | - | - | - | - | - | - | syspe_vip | gpt-4-turbo | [tool1] | 0 | 否 | VIP用户 |
| 7 | - | - | - | - | - | 是 | - | - | - | - | - | - | syspe_ai_top_content | gpt-4-turbo | [rag_tool] | 0 | 否 | 命中AI高质量储备内容 |
| 8 | - | - | - | - | - | - | 是 | - | - | - | - | - | syspe_preset_keywords | gpt-3.5-turbo | [keyword_tool] | 0 | 否 | 命中热点关键词 |
| 9 | - | - | - | - | - | - | - | 是 | - | - | - | - | syspe_common_rag | gpt-3.5-turbo | [common_rag_tool] | 0 | 否 | 命中人设剧情RAG |
| 10 | - | - | - | - | - | - | - | - | 是 | - | - | - | syspe_memory_rag | gpt-4-turbo | [memory_rag_tool] | 0 | 否 | 命中记忆RAG |
| 11 | - | - | - | - | - | - | - | - | - | 是 | - | - | syspe_chat_status | gpt-3.5-turbo | [topic_tool] | 0 | 否 | 话题不足补充热点话题 |
| 12 | - | - | - | - | - | - | - | - | - | - | 是 | - | syspe_deep_topic | gpt-4-turbo | [deep_topic_tool] | 1 | 否 | 深刻话题，使用语音回复 |
| 13 | - | - | - | - | - | - | - | - | - | - | - | 是 | syspe_flirt | gpt-3.5-turbo | [] | 2 | 是 | 调情场景，返回表情包 |
| 14 | 女 | - | - | - | - | - | - | - | - | - | - | - | syspe_female | gpt-3.5-turbo | [] | 0 | 否 | 女性用户 |
| 15 | 男 | - | - | - | - | - | - | - | - | - | - | - | syspe_male | gpt-3.5-turbo | [] | 0 | 否 | 男性用户 |
| 16 | - | - | - | - | - | - | - | - | - | - | - | - | syspe_default | gpt-3.5-turbo | [] | 0 | 否 | 默认规则 |



至此，你们的业务代码完全按照上述表格实现。
公司所有人员，产品/测试/开发/销售/老板都按照这张表格对齐理解该业务即可。
