# ChatSession 业务规则表

本文档定义了不同输入变量组合对应的输出变量规则。规则按优先级从高到低排列，高优先级规则会覆盖低优先级规则。

## 规则说明

- **优先级**: 数字越小优先级越高，高优先级规则会覆盖低优先级规则
- **条件匹配**: 所有列出的条件必须同时满足，该规则才会生效
- **默认值**: 如果所有规则都不匹配，使用默认值
- **命中判断**: `是` 表示对应的 Output 不为 nil，`否` 表示为 nil，`-` 表示不参与匹配

## 业务规则表

| 优先级 | 性别 | 等级 | 是否VIP | 国籍 | 是否敏感内容 | 命中AI高质量储备 | 命中热点关键词 | 命中人设剧情RAG | 命中记忆RAG | 话题不足补充 | 深刻话题 | 是否调情 | SystemPE | LLM模型 | 工具列表 | 回复类型 | 是否需要表情包 | 备注 |
|--------|------|------|---------|------|--------------|------------------|----------------|-----------------|------------|--------------|----------|----------|----------|---------|----------|----------|----------------|------|
| 1 | 女 | - | - | 中国 | - | - | - | - | - | - | - | - | syspe_chinese_female | gpt-4-turbo | [] | 2 | 是 | 中国女性用户特殊处理 |
| 2 | 男 | - | 是 | - | 是 | - | - | - | - | - | - | - | syspe_vip_male_sensitive | gpt-4-turbo | [tool1, tool2] | 0 | 否 | VIP男性敏感话题 |
| 3 | 男 | - | - | - | 是 | - | - | - | - | - | - | - | syspe_male_sensitive | gpt-3.5-turbo | [tool1] | 0 | 否 | 男性敏感话题 |
| 4 | 女 | >=5 | - | - | - | - | - | - | - | - | - | - | syspe_female_level5+ | gpt-4-turbo | [] | 0 | 否 | 女性5级以上用户 |
| 5 | - | >=10 | 是 | - | - | - | - | - | - | - | - | - | syspe_high_level_vip | gpt-4-turbo | [tool1, tool2, tool3] | 0 | 否 | 高等级VIP用户 |
| 6 | - | - | 是 | - | - | - | - | - | - | - | - | - | syspe_vip | gpt-4-turbo | [tool1] | 0 | 否 | VIP用户 |
| 7 | - | - | - | - | - | 是 | - | - | - | - | - | - | syspe_ai_top_content | gpt-4-turbo | [rag_tool] | 0 | 否 | 命中AI高质量储备内容 |
| 8 | - | - | - | - | - | - | 是 | - | - | - | - | - | syspe_preset_keywords | gpt-3.5-turbo | [keyword_tool] | 0 | 否 | 命中热点关键词 |
| 9 | - | - | - | - | - | - | - | 是 | - | - | - | - | syspe_common_rag | gpt-3.5-turbo | [common_rag_tool] | 0 | 否 | 命中人设剧情RAG |
| 10 | - | - | - | - | - | - | - | - | 是 | - | - | - | syspe_memory_rag | gpt-4-turbo | [memory_rag_tool] | 0 | 否 | 命中记忆RAG |
| 11 | - | - | - | - | - | - | - | - | - | 是 | - | - | syspe_chat_status | gpt-3.5-turbo | [topic_tool] | 0 | 否 | 话题不足补充热点话题 |
| 12 | - | - | - | - | - | - | - | - | - | - | 是 | - | syspe_deep_topic | gpt-4-turbo | [deep_topic_tool] | 1 | 否 | 深刻话题，使用语音回复 |
| 13 | - | - | - | - | - | - | - | - | - | - | - | 是 | syspe_flirt | gpt-3.5-turbo | [] | 2 | 是 | 调情场景，返回表情包 |
| 14 | 女 | - | - | - | - | - | - | - | - | - | - | - | syspe_female | gpt-3.5-turbo | [] | 0 | 否 | 女性用户 |
| 15 | 男 | - | - | - | - | - | - | - | - | - | - | - | syspe_male | gpt-3.5-turbo | [] | 0 | 否 | 男性用户 |
| 16 | - | - | - | - | - | - | - | - | - | - | - | - | syspe_default | gpt-3.5-turbo | [] | 0 | 否 | 默认规则 |

## 字段说明

### 输入变量

#### 用户基础信息 (UserInfoResult)
- **性别**: `male`(男) / `female`(女)
- **等级**: 整数，范围 0-100
- **是否VIP**: `true`(是) / `false`(否)
- **国籍**: 国家代码，如 `中国`、`美国` 等

#### 内容检查结果 (UserContentSensitiveCheckResult)
- **是否敏感内容**: `true`(是) / `false`(否)

#### RAG/Output 命中判断
- **命中AI高质量储备**: `AITopContentOutput != nil`
- **命中热点关键词**: `AIPresetKeywordsOutput != nil`
- **命中人设剧情RAG**: `CommonRAGOutput != nil`
- **命中记忆RAG**: `MemoryRAGOutput != nil`
- **话题不足补充**: `ChatStatusOutput != nil`
- **深刻话题**: `DeepTopicOutput != nil`
- **是否调情**: `JudgeFlirtOutput != nil`

### 输出变量 (ChatLlmModelParams)

- **SystemPE**: SystemPrompt的标识符，如 `syspe_chinese_female`
- **LLM模型**: 使用的模型名称，如 `gpt-4-turbo`、`gpt-3.5-turbo`
- **工具列表**: 需要启用的工具数组，如 `[tool1, tool2]`，空数组用 `[]` 表示
- **UserContentSlots**: userContent的槽位信息，根据不同的命中情况填充不同的槽位数据（具体槽位内容由业务逻辑决定）
- **回复类型**: 
  - `0`: 普通文本回复
  - `1`: 语音条回复
  - `>=2`: 表情包回复并结束对话
- **是否需要表情包**: `true`(是) / `false`(否)

## 规则维护说明

1. **新增规则**: 在表格中按优先级插入新行，确保优先级数字唯一且连续
2. **修改规则**: 直接修改对应行的字段值
3. **删除规则**: 删除对应行，并重新调整优先级数字
4. **优先级调整**: 修改优先级数字，确保高优先级规则在前

## 注意事项

- 规则匹配采用**从上到下**的顺序，第一个匹配的规则生效
- 条件中的 `-` 表示该字段不参与匹配（任意值都匹配）
- 条件中的 `>=5` 表示大于等于5的值都匹配
- 条件中的 `是` 表示对应的 Output 不为 nil，`否` 表示为 nil
- 所有规则都不匹配时，使用优先级最低的默认规则（优先级16）
- UserContentSlots 的具体内容需要根据业务逻辑和命中的 Output 类型来填充，不在本规则表中详细枚举
